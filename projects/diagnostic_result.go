/*
 * Copyright (c) 2026, WSO2 LLC. (http://www.wso2.com).
 *
 * WSO2 LLC. licenses this file to you under the Apache License,
 * Version 2.0 (the "License"); you may not use this file except
 * in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */

package projects

import "sync"

// DiagnosticResult represents a collection of diagnostics generated by compilation.
// This type is immutable; filtered collections are computed lazily and cached.
// Matches Java's DiagnosticResult API.
type DiagnosticResult struct {
	allDiagnostics []Diagnostic
	errors         []Diagnostic
	warnings       []Diagnostic
	hints          []Diagnostic
	errorsOnce     sync.Once
	warningsOnce   sync.Once
	hintsOnce      sync.Once
}

// NewDiagnosticResult creates a DiagnosticResult from a slice of diagnostics.
func NewDiagnosticResult(diagnostics []Diagnostic) *DiagnosticResult {
	// Make a defensive copy
	copied := make([]Diagnostic, len(diagnostics))
	copy(copied, diagnostics)
	return &DiagnosticResult{
		allDiagnostics: copied,
	}
}

// Diagnostics returns all diagnostics.
func (r *DiagnosticResult) Diagnostics() []Diagnostic {
	return r.allDiagnostics
}

// Errors returns only error-level diagnostics.
func (r *DiagnosticResult) Errors() []Diagnostic {
	r.errorsOnce.Do(func() {
		r.errors = filterBySeverity(r.allDiagnostics, SeverityError)
	})
	return r.errors
}

// Warnings returns only warning-level diagnostics.
func (r *DiagnosticResult) Warnings() []Diagnostic {
	r.warningsOnce.Do(func() {
		r.warnings = filterBySeverity(r.allDiagnostics, SeverityWarning)
	})
	return r.warnings
}

// Hints returns only hint-level diagnostics.
func (r *DiagnosticResult) Hints() []Diagnostic {
	r.hintsOnce.Do(func() {
		r.hints = filterBySeverity(r.allDiagnostics, SeverityHint)
	})
	return r.hints
}

// DiagnosticCount returns the total number of diagnostics.
func (r *DiagnosticResult) DiagnosticCount() int {
	return len(r.allDiagnostics)
}

// ErrorCount returns the number of error diagnostics.
func (r *DiagnosticResult) ErrorCount() int {
	return len(r.Errors())
}

// WarningCount returns the number of warning diagnostics.
func (r *DiagnosticResult) WarningCount() int {
	return len(r.Warnings())
}

// HintCount returns the number of hint diagnostics.
func (r *DiagnosticResult) HintCount() int {
	return len(r.Hints())
}

// HasErrors returns true if there are any error-level diagnostics.
func (r *DiagnosticResult) HasErrors() bool {
	return r.ErrorCount() > 0
}

// HasWarnings returns true if there are any warning-level diagnostics.
func (r *DiagnosticResult) HasWarnings() bool {
	return r.WarningCount() > 0
}

// filterBySeverity filters diagnostics by severity.
func filterBySeverity(diagnostics []Diagnostic, severity DiagnosticSeverity) []Diagnostic {
	var filtered []Diagnostic
	for _, d := range diagnostics {
		if d.Severity == severity {
			filtered = append(filtered, d)
		}
	}
	return filtered
}
